---
title: 'B2: Air Plume'
author: "Αντώνιος Νεκτάριος Ντουντούκαλης"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document:
    toc: true
    toc_depth: '3'
  html_document:
    includes:
      in_header: header.html
    code_folding: show
    theme: flatly
    highlight: tango
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
  pdf_document:
    toc: true
    toc_depth: '3'
---

<div style="text-align: center; font-size: 30px; font-weight: bold; margin-bottom: 20px; color: #FF5733;">
  Μάθημα: Γεωγραφική Ανάλυση
</div>  

![](gis_layers.png)

``` {r setup, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
"
getwd()
setwd('d:\\Users\\geo21071\\Downloads\\data')
"
library(sf)
library(terra)
library(dplyr)
library(tmap)
library(ggpubr)

st_layers("Exported2/Vectors.gpkg")

acto = st_read("Exported2/Vectors.gpkg", layer="acto", quiet = T )
oik = st_read("Exported2/Vectors.gpkg", layer="oik", quiet = T )
nuclear = st_read("Exported2/Vectors.gpkg", layer="nuclear", quiet = T )
#stations = st_read("Exported2/Vectors.gpkg", layer="stations", quiet = T )
enotites= st_read("Exported2/Vectors.gpkg", layer="enotites", quiet = T )

corine = rast("Exported2/Corine.tif")
dem = rast("Exported2/dem.tif") # Δεν θα χρησημοποιηθεί
ActualPollution = rast("Exported2/ActualPollution.tif")

TheThreshold=7500

```
<style>
/* Υπογραμμίζουμε τίτλους (h1, h2, h3 κ.λπ.), όχι το author ή το date */
h1, h2, h3, h4, h5 {
    text-decoration: underline;
}

/* Αφαιρούμε την υπογράμμιση από το TOC */
#toc a, #TOC a {
    text-decoration: none !important;
}

/* Αφαιρούμε την υπογράμμιση από το author και το date */
.author, .date {
    text-decoration: none !important;
}
</style>

## Ερώτημα 1: Πληθυσμός  

Πόσα άτομα επηρεάζονται από την έκθεση σε επίπεδο 7500 ng; Πού βρίσκονται οι πληγείσες πόλεις;  

> Επιλογή ολων των οικισμών με μόλυνση >= 7500.

```{r selpoppol}
oik$ActualPollution = terra::extract(ActualPollution, oik, ID=F)[[1]]
oik2 = subset(oik, ActualPollution >= TheThreshold)
dim(oik2)
```  

Υπάρχουν `r nrow(oik2)` οικισμοί με έκθεση σε μόλυνση >= 7500. Άθροισμα πληθυσμού:
```{r}
sum(oik2$pop2011)
```  

Οπτικοποιηση των `r nrow(oik2)` οικισμών με συνολικό πληθυσμό `r sum(oik2$pop2011)` κατοίκους.    
<br>
**Χάρτης 1.1**
```{r}
par(mar=c(1,1,2,1) )
plot(st_geometry(acto), main=sprintf("Οικισμοί σε επικύνδινη ζώνη\n>= %s ng",TheThreshold) )
plot(st_geometry(oik2), main="Towns", pch=19, cex=0.6, col="red", add=T)
plot(st_geometry(nuclear), add=T, pch=23, bg="black", col="black")
legend(x='bottomleft', pch=c(19,23), legend=c("Οικισμοι","Εργοστάσιο"),
       col=c("red","black"), pt.bg="black", bg=NULL, box.lwd=0)
box()
```  

**Χάρτης 1.2** 
```{r}
par(mar=c(0,0,0,0) )
terra::plot(ActualPollution, axes=F, box=F, main="Οικισμοί σε επικύνδινη ζώνη", plg=list(loc="bottom") )
plot(st_geometry(acto), main=sprintf("Οικισμοί σε επικύνδινη ζώνη\n>= %s ng",TheThreshold), add=T)
plot(st_geometry(oik),   pch=19, cex=0.5, col=rgb(red=0.1,green=0,blue=0,alpha=0.1), add=T)
plot(st_geometry(oik2),  pch=19, cex=0.6, col="red", add=T)
plot(st_geometry(nuclear), add=T, pch=23, bg="black", col="black")
legend(xpd=T, x='bottomleft', pch=c(19,23), legend=c("Οικισμοι","Εργοστάσιο"),  col=c("red","black"), pt.bg="black", bg=NULL, box.lwd=0)
box()
```  

### Απάντηση 1ου ερωτήματος

Υπάρχουν `r nrow(oik2)` οικισμοί με συνολικό πληθυσμό `r sum(oik2$pop2011)` κατοικων, που επιρεάζονται απο την μολυνση των `r TheThreshold` ng.


## Ερώτημα 2: Αγροτικές εκτάσεις  

Πόση αγροτική έκταση (km2) επηρεάζεται από την έκθεση σε επίπεδο 7500 ng; Πού βρίσκονται αυτές οι περιοχές;  

### Επιλογή αγροτικών εκτάσεων  

Επιλογή μόνο των αγροτικών εκτάσεων απο τα δεδομένα CORINE και μετατρωπη σε πολύγωνο.

```{r}
corine
```  

Ποιες κατηγορίες περιλαμβάνει το Corine ;
```{r}
levels(corine)[[1]]
```  

Ποιο είναι το πλήθος κελιών ανά κατηγορία;  
```{r}
#pol = rasterToPolygons(corine, fun=function(x){x==2})
table(corine[])
```  

Ποιο ειναι το συνολικό εμβαδό των αγροτικών εκτάσεων;  
```{r}
cellSize = cellSize(corine[[1]])[][[1]] / 1000000
ola = sum(table(corine[]))
agr = sum((corine==2)[], na.rm=T)
emvado_agrotika = round((agr*cellSize) ,1)
emvado_agrotika
```  

Το ποσοστό των συνολικών αγροτικών κελιών;  
```{r}
pososto = 100*(agr/ola)
pososto
res(corine==2) %>% prod() # Εναλακτικός τρόπος υπολογισμού του cell size (m)
```  

**Χάρτης 2.1**  
```{r}
plot( (corine==2), main=sprintf("Αγροτικές περιοχές (%s%% των κελιών)\n(%s χλμ^2)",
                                round(pososto,1), emvado_agrotika ))
plot(st_geometry(acto), add=T )
```  

### Επιλογή μεγάλης μόλυνσης  

Απο το raster της μόλυνσης, επιλογή μονο των κελιών που ειναι πάνω απο το όριο TheThreshold.  
```{r}
bigPolution = ( ActualPollution >= TheThreshold )
#bigPolution = terra::crop(  bigPolution, vect(acto) ) %>% mask(vect(acto))
#bigPolution = classify(bigPolution, cbind(c(TRUE, FALSE), c(1,NA))  )
```  

Πόσα κελιά είνα πάνω απο το όριο της μέγάλης μολυνσης;  

```{r}
table(bigPolution[])
```  

Ποιό είναι το εμβαδό της μεγάλης μολυνσης;  

```{r}
emvado_bigPollution = res(bigPolution) %>% prod()
(emvado_bigPollution)
```  

Οπτικοποίηση raster μεγάλης μολυνσης:  

```{r}
plot(bigPolution, main=sprintf("Μεγάλη μόλυνση (%s χλμ^2)", round(emvado_bigPollution ,1) ), legend=F, col=c(NA,"orange"))
plot(st_geometry(acto), add=T)
plot(st_geometry(nuclear), add=T, pch=23, bg="black", col="black")
legend(x='bottomleft', pch=c(19,23), legend=c("Big Pollution","Plant"),
       col=c("green4","black"), pt.bg="black", bg=NULL, box.lwd=0)
```  
<br>

### Μεγάλη μόλυνση + Αγροτικές εκτάσεις  

Οπτικοποίηση των δυο raster:  

```{r}
par(mfrow = c(2, 1))
plot(corine==2, main="CORINE (Αγροτικά)", col=c(NA,"orange"))
plot(acto, add=T, col=NA)

plot(bigPolution, main="Μεγάλη μόλυνση", col=c(NA,"green"))
plot(acto, add=T, col=NA)
```  

Ποιο ειναι το μέγεθος κελιού των δυο raster (resolution). Είναι διαφορετικό. Αρα θα χρειαστεί να κάνουμε επαναδειγματοληψία (resample), ώστε να έχουμε στη διάθεση μας δυο raster με ίδιο μέγεθος κελιου.  

```{r}
res(corine)
res(bigPolution)
```  

Επαναδειγματοληψία (resample) CORINE στις διαστάσεις του bigPolution (raster μεγάλης μόλυνσης):  

```{r}
r2 = resample((corine==2), bigPolution, method='near')
plot(r2, main="Αγροτικά + Mόλυνση", col=c(NA,rgb(1,0.64,0,0.7)), legend=F )
plot(bigPolution,  col=c(NA,rgb(0,1,0,0.5)), add=T, legend=F)
plot(st_geometry( acto), add=T, col=NA)
```  

Πληροφορίες κελιών του raster: CORINE  

```{r}
table((corine==2)[])
```  

Πληροφορίες κελιών του raster: resampled CORINE  
```{r}
table(r2[])
```  

Πληροφορίες κελιών του raster: της μεγάλης μολυνσης  

```{r}
table(bigPolution[])
```  

Συνθεση των δυο raster: Resampled CORINE + μεγάλη μολυνση  

```{r}
result = (r2 + (bigPolution))==2
plot(result , main="Αποτέλεσμα: Αγροτικά (CORINE)+\n μεγάλη μολυνση")
table(result[])
```  

Πλήθος θετικών κελιών  

```{r}
ncells = sum((result[]==1), na.rm=T)
ncells
```  

Εμβαδό του κάθε κελιού  

```{r}
emvado_cell = res(result) %>% prod()
emvado_cell
```  

Συνολικό εμβαδό των θετικών κελιών  

```{r}
result_emvado = (ncells * emvado_cell)/1000000
result_emvado <- round(result_emvado, 1)
```

### Απάντηση 2ου ερωτήματος  

Από τα `r emvado_agrotika` χλμ^2 της **συνολικής** αγροτικής εκτασης, υπάρχουν `r result_emvado` χλμ^2 τα οποία βρίσκονται σε περιοχή πάνω απο το όριο των `r TheThreshold`ng μολυνσης. Δηλαδή είναι το `r round((result_emvado/emvado_agrotika) * 100, 1)`% της **συνολικής** αγροτικής εκτασης.

## Ερώτημα 3: Διοικητικές ενότητες  

Ποιες Διοικητικές Ενότητες έχουν μέσο όρο μόλυνσης μεγαλύτερο από το όριο;  

* Για κάθε μια απο τις `r nrow(enotites)` Διοικητικές Ενοτητες, υπολογισμός της μολυνσης εντός του κάθε πολυγώνου:  
  + Μέσος Ορος: <span style="color: blue;">meanPolution</span>
  + Συνολικό εμβαδό Διοικητής Ενότητας: <span style="color: blue;">area</span>  

```{r}
enotites$meanPolution = raster::extract(ActualPollution, enotites, fun=mean )$layer
enotites$area = st_area(enotites)
```  

Ποιες Διοικητικές Ενοτητες έχουν ΜΟ μεγαλύτερο απο το όριο των 7500;  

```{r echo = TRUE, eval = TRUE, results="hide", fig.keep = "none"}
enotites$danger = ifelse(enotites$meanPolution>=TheThreshold, TRUE, FALSE)
 
 
ggbarplot(enotites %>% as_tibble(), x = "lektiko", y = "meanPolution",
          fill = "danger",
          color = "danger",
          sort.val = "asc",          # Sort the value in dscending order
          rotate = T,
          x.text.angle = 90,           # Rotate vertically x axis texts
          ggtheme = theme_bw(),
          palette = "Set2", legend = "bottom"
)
```  

![](enotitesdanger.png)

Απλοί θεματικοί χάρτες  

**Χάρτης 3.1**  

```{r}
qtm(enotites, fill = "meanPolution" )+ tm_layout(legend.position = c("right", "top")  )
```


**Χάρτης 3.2**

```{r}
qtm(enotites, fill = "danger" )+ tm_layout(legend.position = c("right", "top")  
)
```

### Απάντηση 3ου ερωτήματος  

Υπάρχουν `r sum(enotites$danger)` Διοικητικές Ενότητες με μεσο όρο μεγαλύτερο απο το όριο 7500.

## Πηγαίος Κώδικας  
``` {r sourcecode}
# "
# getwd()
# setwd('d:\\Users\\geo21071\\Downloads\\data')
# "
# library(sf)
# library(terra)
# library(dplyr)
# library(tmap)
# library(ggpubr)
# 
# st_layers("Exported2/Vectors.gpkg")
# 
# acto = st_read("Exported2/Vectors.gpkg", layer="acto", quiet = T )
# oik = st_read("Exported2/Vectors.gpkg", layer="oik", quiet = T )
# nuclear = st_read("Exported2/Vectors.gpkg", layer="nuclear", quiet = T )
# #stations = st_read("Exported2/Vectors.gpkg", layer="stations", quiet = T )
# enotites= st_read("Exported2/Vectors.gpkg", layer="enotites", quiet = T )
# 
# corine = rast("Exported2/Corine.tif")
# dem = rast("Exported2/dem.tif") # Δεν θα χρησημοποιηθεί
# ActualPollution = rast("Exported2/ActualPollution.tif")
# 
# par(mar=c(1,1,1,3) )
# mycol = c("grey30","orange","green","purple","blue")
# plot(corine, legend = T, col = mycol)
# #legend(x='bottomleft', xpd=T, inset=c(0.98, 0.40),
# #       legend=levels(corine)[[1]]$value,
# #       fill = mycol,bg =NULL, box.lwd = 0)
# plot(st_geometry(acto), add=T, border="grey40")
# 
# par(mar=c(1,1,1,1) )
# plot(st_geometry(oik), main="Towns", pch=19, cex=0.6, col="red")
# plot(st_geometry(acto), add=T, border="grey40")
# plot(st_geometry(nuclear), add=T, pch=23, col="black", bg="black"  )
# legend(x='bottomleft', pch=c(19,23), legend=c("Towns","Plant"),
#        col=c("red","black"), pt.bg="black", bg=NULL, box.lwd=0)
# box()
# 
# plot((ActualPollution), main="Actual Pollution")
# plot(st_geometry(acto), add=T, border="grey40")
# #plot(st_geometry(stations), add=T, pch=6, col="blue")
# plot(st_geometry(nuclear), add=T, pch=23, col="black", bg="black")
# 
# legend(x='bottomleft', xpd=T, inset=c(0.10, 0.03),
#        pch=c(6,23),
#        legend=c("Nuclear Plant"),
#        col = c("black"), pt.bg="black",
#        bg =NULL, box.lwd = 0)
# 
# TheThreshold=7500
# plot(st_geometry(enotites), main="Administrative sub-units", border="grey40" )
# plot(st_geometry(acto), add=T  )
# text(st_coordinates(st_centroid( enotites)), label=enotites$kalcode,  cex=0.4,col="blue" ) #
# box()
# 
# oik$ActualPollution = terra::extract(ActualPollution, oik, ID=F)[[1]]
# oik2 = subset(oik, ActualPollution >= TheThreshold)
# dim(oik2)
# 
# sum(oik2$pop2011)
# 
# par(mar=c(1,1,2,1) )
# plot(st_geometry(acto), main=sprintf("Οικισμοί σε επικύνδινη ζώνη\n>= %s ng",TheThreshold) )
# plot(st_geometry(oik2), main="Towns", pch=19, cex=0.6, col="red", add=T)
# plot(st_geometry(nuclear), add=T, pch=23, bg="black", col="black")
# legend(x='bottomleft', pch=c(19,23), legend=c("Οικισμοι","Εργοστάσιο"),
#        col=c("red","black"), pt.bg="black", bg=NULL, box.lwd=0)
# box()
# 
# par(mar=c(0,0,0,0) )
# terra::plot(ActualPollution, axes=F, box=F, main="Οικισμοί σε επικύνδινη ζώνη", plg=list(loc="bottom") )
# plot(st_geometry(acto), main=sprintf("Οικισμοί σε επικύνδινη ζώνη\n>= %s ng",TheThreshold), add=T)
# plot(st_geometry(oik),   pch=19, cex=0.5, col=rgb(red=0.1,green=0,blue=0,alpha=0.1), add=T)
# plot(st_geometry(oik2),  pch=19, cex=0.6, col="red", add=T)
# plot(st_geometry(nuclear), add=T, pch=23, bg="black", col="black")
# legend(xpd=T, x='bottomleft', pch=c(19,23), legend=c("Οικισμοι","Εργοστάσιο"),  col=c("red","black"), pt.bg="black", bg=NULL, box.lwd=0)
# box()
# 
# corine
# 
# levels(corine)[[1]]
# 
# #pol = rasterToPolygons(corine, fun=function(x){x==2})
# table(corine[])
# 
# cellSize = cellSize(corine[[1]])[][[1]] / 1000000
# ola = sum(table(corine[]))
# agr = sum((corine==2)[], na.rm=T)
# emvado_agrotika = round((agr*cellSize) ,1)
# emvado_agrotika
# 
# pososto = 100*(agr/ola)
# pososto
# 
# res(corine==2) %>% prod() # Εναλακτικός τρόπος υπολογισμού του cell size (m)
# 
# plot( (corine==2), main=sprintf("Αγροτικές περιοχές (%s%% των κελιών)\n(%s χλμ^2)",
#                                 round(pososto,1), emvado_agrotika ))
# plot(st_geometry(acto), add=T )
# 
# bigPolution = ( ActualPollution >= TheThreshold )
# #bigPolution = terra::crop(  bigPolution, vect(acto) ) %>% mask(vect(acto))
# #bigPolution = classify(bigPolution, cbind(c(TRUE, FALSE), c(1,NA))  )
# 
# table(bigPolution[])
# 
# emvado_bigPollution = res(bigPolution) %>% prod()
# (emvado_bigPollution)
# 
# 
# plot(bigPolution, main=sprintf("Μεγάλη μόλυνση (%s χλμ^2)", round(emvado_bigPollution ,1) ), legend=F, col=c(NA,"orange"))
# plot(st_geometry(acto), add=T)
# plot(st_geometry(nuclear), add=T, pch=23, bg="black", col="black")
# legend(x='bottomleft', pch=c(19,23), legend=c("Big Pollution","Plant"),
#        col=c("green4","black"), pt.bg="black", bg=NULL, box.lwd=0)
# 
# par(mfrow = c(2, 1))
# plot(corine==2, main="CORINE (Αγροτικά)", col=c(NA,"orange"))
# plot(acto, add=T, col=NA)
# 
# plot(bigPolution, main="Μεγάλη μόλυνση", col=c(NA,"green"))
# plot(acto, add=T, col=NA)
# 
# res(corine)
# res(bigPolution)
# 
# 
# r2 = resample((corine==2), bigPolution, method='near')
# plot(r2, main="Αγροτικά + Mόλυνση", col=c(NA,rgb(1,0.64,0,0.7)), legend=F )
# plot(bigPolution,  col=c(NA,rgb(0,1,0,0.5)), add=T, legend=F)
# plot(st_geometry( acto), add=T, col=NA)
# 
# table((corine==2)[])
# table(r2[])
# table(bigPolution[])
# result = (r2 + (bigPolution))==2
# plot(result , main="Αποτέλεσμα: Αγροτικά (CORINE)+\n μεγάλη μολυνση")
# table(result[])
# ncells = sum((result[]==1), na.rm=T)
# ncells
# emvado_cell = res(result) %>% prod()
# emvado_cell
# 
# result_emvado = (ncells * emvado_cell)/1000
# result_emvado
# 
# 
# enotites$meanPolution = raster::extract(ActualPollution, enotites, fun=mean )$layer
# enotites$area = st_area(enotites)
# enotites$danger = ifelse(enotites$meanPolution>=TheThreshold, TRUE, FALSE)
# 
# 
# ggbarplot(enotites %>% as_tibble(), x = "lektiko", y = "meanPolution",
#           fill = "danger",
#           color = "danger",
#           sort.val = "asc",          # Sort the value in dscending order
#           rotate = T,
#           x.text.angle = 90,           # Rotate vertically x axis texts
#           ggtheme = theme_bw(),
#           palette = "Set2", legend = "bottom"
# )
# 
# qtm(enotites, fill = "meanPolution" )+ tm_layout(legend.position = c("right", "top")  )
# qtm(enotites, fill = "danger" )+ tm_layout(legend.position = c("right", "top")  )


```  

## Βιβλιογραφία  
* Καβρουδάκης, Δ. (2022) ΠΠΣ Γεωγραφική Ανάλυση (ΓΕΟ 302). 
  + Διαθέσιμο στο: [Open eClass, Πανεπιστήμιο Αιγαίου](https://eclass.aegean.gr/courses/GEO157/)
  + (Πρόσβαση: 10/12/2024).   

![](aegean.png)  
